<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIP Cartoon & Paint Generator</title>
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
body { font-family: Arial; text-align: center; padding: 20px; background: #f5f5f5; }
img, canvas { max-width: 300px; margin: 10px; border: 2px solid #333; }
button { padding: 10px 20px; margin: 10px; font-size: 16px; }
</style>
</head>
<body>

<h2>Cartoon & Paint-like Generator (Exact DIP)</h2>
<input type="file" id="upload" accept="image/*"><br>
<button id="generateBtn" style="display:none;">Generate</button>

<div id="images"></div>
<button id="downloadZip" style="display:none;">Download ZIP</button>

<script>
let originalImg = null;
let cartoonCanvas = null;
let paintCanvas = null;

// Wait for OpenCV to load
cv['onRuntimeInitialized']=()=>{
  console.log("OpenCV.js is ready!");
  document.getElementById('upload').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(event){
      const img = new Image();
      img.onload = function(){
        originalImg = img;
        document.getElementById('images').innerHTML = `<h3>Original</h3>`;
        document.getElementById('images').appendChild(img);
        document.getElementById('generateBtn').style.display = 'inline-block';
      }
      img.src = event.target.result;
    }
    reader.readAsDataURL(file);
  });

  document.getElementById('generateBtn').addEventListener('click', function(){
    if(!originalImg) return;

    const width = originalImg.width;
    const height = originalImg.height;

    // Create OpenCV mats
    let src = cv.imread(originalImg);
    let imgRGB = new cv.Mat();
    cv.cvtColor(src, imgRGB, cv.COLOR_RGBA2RGB);

    // --------- K-means Color Quantization (Cartoon) ----------
    let Z = imgRGB.reshape(1, imgRGB.rows*imgRGB.cols);
    Z.convertTo(Z, cv.CV_32F);
    let K = 9;
    let criteria = new cv.TermCriteria(cv.TermCriteria_EPS + cv.TermCriteria_MAX_ITER, 20, 1.0);
    let attempts = 10;
    let labels = new cv.Mat();
    let centers = new cv.Mat();
    cv.kmeans(Z, K, labels, criteria, attempts, cv.KMEANS_RANDOM_CENTERS, centers);
    centers.convertTo(centers, cv.CV_8U);
    let quantizedData = new Uint8ClampedArray(Z.rows*3);
    for(let i=0; i<Z.rows; i++){
      let center_id = labels.intAt(i,0);
      quantizedData[i*3] = centers.ucharAt(center_id,0);
      quantizedData[i*3+1] = centers.ucharAt(center_id,1);
      quantizedData[i*3+2] = centers.ucharAt(center_id,2);
    }
    let cartoon = new cv.Mat(imgRGB.rows, imgRGB.cols, imgRGB.type());
    cartoon.data.set(quantizedData);

    // --------- Paint-like Smooth Effect ----------
    let smooth = new cv.Mat();
    cv.bilateralFilter(cartoon, smooth, 15, 100, 100, cv.BORDER_DEFAULT);

    // Display images
    cartoonCanvas = document.createElement('canvas');
    paintCanvas = document.createElement('canvas');
    cv.imshow(cartoonCanvas, cartoon);
    cv.imshow(paintCanvas, smooth);

    const imagesDiv = document.getElementById('images');
    imagesDiv.innerHTML = `<h3>Original</h3>`;
    imagesDiv.appendChild(originalImg);
    imagesDiv.innerHTML += `<h3>Cartoon (Quantized)</h3>`;
    imagesDiv.appendChild(cartoonCanvas);
    imagesDiv.innerHTML += `<h3>Paint-like Smooth Cartoon</h3>`;
    imagesDiv.appendChild(paintCanvas);
    document.getElementById('downloadZip').style.display='inline-block';

    // Clean up
    src.delete(); imgRGB.delete(); labels.delete(); centers.delete(); cartoon.delete(); smooth.delete();
  });

  document.getElementById('downloadZip').addEventListener('click', function(){
    const zip = new JSZip();
    zip.file("cartoon_quantized.png", cartoonCanvas.toDataURL().split(",")[1], {base64:true});
    zip.file("paint_like_cartoon.png", paintCanvas.toDataURL().split(",")[1], {base64:true});
    zip.generateAsync({type:"blob"}).then(function(content){
      saveAs(content,"cartoon_results.zip");
    });
  });
}
</script>
</body>
</html>
